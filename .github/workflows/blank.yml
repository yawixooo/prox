name: Python Proxy Runner

on:
  schedule:
    # –ó–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∂–¥—ã–π —á–∞—Å
    - cron: '0 * * * *'
  workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  push:
    branches: [ main, master ]

jobs:
  run-proxy-script:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PROXY_UPDATE_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Run proxy.py script
      run: |
        echo "Running proxy.py..."
        python parse.py
    
    - name: Create/clean proxy_data directory
      run: |
        rm -rf proxy_data
        mkdir -p proxy_data
    
    - name: Move proxy files to directory
      run: |
        # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø—Ä–æ–∫—Å–∏ –≤ proxy_data
        for file in socks4_proxies.txt ; do
          if [ -f "$file" ]; then
            cp "$file" "proxy_data/"
            echo "Copied $file to proxy_data/"
          fi
        done
        
        # –°–æ–∑–¥–∞–µ–º README –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        echo "# Proxy Data" > proxy_data/README.md
        echo "This directory contains automatically updated proxy lists." >> proxy_data/README.md
        echo "" >> proxy_data/README.md
        echo "## Files" >> proxy_data/README.md
        echo "- \`socks4_proxies.txt \` - Plain text list of proxies" >> proxy_data/README.md
        echo "" >> proxy_data/README.md
        echo "Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> proxy_data/README.md
    
    - name: Configure Git
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
    
    - name: Commit and push changes
      env:
        REPO_TOKEN: ${{ secrets.PROXY_UPDATE_TOKEN }}
      run: |
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å git
        git status
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        git add -A
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –∫–æ–º–º–∏—Ç–∞
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          # –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git commit -m "ü§ñ Auto-update proxy data [$(date +'%Y-%m-%d %H:%M UTC')]"
          
          # –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git push https://x-access-token:${REPO_TOKEN}@github.com/${{ github.repository }}.git HEAD:main
          echo "Changes pushed successfully"
        fi
